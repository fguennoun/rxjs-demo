<!--  ======================================
 ğŸ“ posts.component.html - The template
============================================ -->

<div class="container">
  <h1>ğŸ“š Posts List (RxJS + Angular)</h1>

  <div class="explanation">
    <h3>ğŸ’¡ RxJS Concepts Used:</h3>
    <ul>
      <li><strong>HttpClient</strong> returns Observables automatically</li>
      <li><strong>Pipe operators</strong>: map, filter, tap, catchError, retry, switchMap</li>
      <li><strong>debounceTime</strong>: Optimizes search (300ms delay)</li>
      <li><strong>combineLatest</strong>: Combines multiple Observables</li>
      <li><strong>async pipe</strong>: Automatically handles subscribe/unsubscribe</li>
      <li><strong>shareReplay</strong>: Caches HTTP results</li>
      <li><strong>fromEvent</strong>: Keyboard shortcuts (R=refresh, C=clear, F=focus)</li>
      <li><strong>interval</strong>: Auto-refresh functionality</li>
      <li><strong>merge</strong>: Combines manual and auto refresh triggers</li>
      <li><strong>Subject</strong>: Notification system</li>
    </ul>
  </div>

  <!-- Notification Toast -->
  @if (currentNotification) {
    <div class="notification">
      {{ currentNotification }}
    </div>
  }

  <div class="controls">
    <input
      type="text"
      [formControl]="searchControl"
      placeholder="ğŸ” Search... (Press F to focus)"
      class="search-input"
    >

    <select [formControl]="userIdControl" class="user-select">
      <option [ngValue]="null">All Users</option>
      <option [ngValue]="1">User 1</option>
      <option [ngValue]="2">User 2</option>
      <option [ngValue]="3">User 3</option>
    </select>

    <div class="sort-controls">
      <span class="sort-label">Sort by:</span>
      <button 
        (click)="changeSort('id')" 
        class="btn-sort"
        [class.active]="sortBy === 'id'">
        ID {{ sortBy === 'id' ? (sortOrder === 'asc' ? 'â†‘' : 'â†“') : '' }}
      </button>
      <button 
        (click)="changeSort('title')" 
        class="btn-sort"
        [class.active]="sortBy === 'title'">
        Title {{ sortBy === 'title' ? (sortOrder === 'asc' ? 'â†‘' : 'â†“') : '' }}
      </button>
      <button 
        (click)="changeSort('userId')" 
        class="btn-sort"
        [class.active]="sortBy === 'userId'">
        User {{ sortBy === 'userId' ? (sortOrder === 'asc' ? 'â†‘' : 'â†“') : '' }}
      </button>
    </div>

    <button (click)="refresh()" class="btn" title="Press R to refresh">ğŸ”„ Refresh</button>
    <button (click)="clearFilters()" class="btn" title="Press C to clear">ğŸ—‘ï¸ Clear Filters</button>
    <button 
      (click)="toggleAutoRefresh()" 
      class="btn"
      [class.active]="autoRefreshEnabled"
      title="Toggle auto-refresh every 30 seconds">
      {{ autoRefreshEnabled ? 'â¸ï¸ Auto-refresh ON' : 'â–¶ï¸ Auto-refresh OFF' }}
    </button>
  </div>

  <!-- âœ… ASYNC PIPE: No need for subscribe()! -->
  @if (stats$ | async; as stats) {
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Posts Displayed</div>
        <div class="stat-value">{{ stats.displayed }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Words</div>
        <div class="stat-value">{{ stats.totalWords }}</div>
      </div>
    </div>
  }

  @if (error) {
    <div class="error">
      âŒ {{ error }}
    </div>
  }

  <!-- âœ… ASYNC PIPE automatically manages subscription -->
  @if (postsWithState$ | async; as state) {
    <!-- Show loading indicator only when loading AND no posts are available yet -->
    @if (state.loading && state.posts.length === 0) {
      <div class="loading">
        â³ Loading...
      </div>
    }

    <!-- Show content area when not loading OR when posts exist -->
    @if (!state.loading || state.posts.length > 0) {
      <!-- Show "no results" message when not loading and no posts -->
      @if (state.posts.length === 0 && !state.loading) {
        <div class="no-results">
          No posts found
        </div>
      }

      <!-- Display posts when they exist -->
      @if (state.posts.length > 0) {
        <div class="posts">
          @for (post of state.posts; track post.id) {
            <div class="post">
              <h3 class="post-title">{{ post.title }}</h3>
              <p class="post-excerpt">{{ post.excerpt }}</p>
              <div class="post-meta">
                <span>ğŸ“ Post #{{ post.id }}</span>
                <span>ğŸ‘¤ User {{ post.userId }}</span>
                <span class="badge">{{ post.wordCount }} words</span>
              </div>
            </div>
          }
        </div>
      }
    }
  } @else {
    <!-- Initial loading state (before postsWithState$ emits) -->
    <div class="loading">â³ Loading posts...</div>
  }
</div>
